AWSTemplateFormatVersion: "2010-09-09"

Description: Time-addressable Media Store API implementation (uksb-yzlyq9dyct)

Metadata:
  cfn-lint:
    config:
      ignore_checks:
        - I3011
        - E3031
        - E3033

Parameters:
  VpcId:
    Description: The ID of an existing VPC, if one exists. Leave blank to have one created.
    Type: String
    Default: ""
    AllowedPattern: '|vpc-[a-z0-9]+'

  VpcAZs:
    Description: Comma-separated list of availability zones (e.g. `us-east-1a,us-east-1b`) to use when a VPC is specified. The number of AZs must match the number of private subnets specified in PrivateSubnetIds.
    Type: CommaDelimitedList
    Default: ""

  PrivateSubnetIds:
    Description: Comma-separated list of private subnets (e.g. subnet-abc123,subnet-def456) to use when a VPC is specified. Must provide exactly one subnet per Availability Zone specified in VpcAZs.
    Type: CommaDelimitedList
    Default: ""
    AllowedPattern: '|subnet-[a-z0-9]+'

  NeptuneDBInstanceClass:
    Description: The DBInstanceClass to be used for the Neptune Database
    Type: String
    Default: db.serverless
    AllowedPattern: ^db\.(serverless|[a-z0-9]+\.[a-z0-9]+)$

  NeptuneServerlessConfiguration:
    Description: Neptune Serverless Scaling Configuration.
    Type: String
    Default: 1,128
    ConstraintDescription: ServerlessScalingConfiguration must be a list of two values, MinCapacity and MaxCapacity, separated by commas. Valid values between 1-128.
    AllowedPattern: (12[0-8]|1[01][0-9]|[1-9][0-9]|[1-9]),(12[0-8]|1[01][0-9]|[1-9][0-9]|[1-9])

  DeployWaf:
    Description: Configure whether a WAF should be deployed infront of the API.
    Type: String
    AllowedValues:
      - "Yes"
      - "No"
    Default: "Yes"

  JwtIssuerUrl:
    Description: '[Optional] The url for the issuer of the JWT tokens you wish to authenticate with. Leave this blank if you wish to deploy Cognito for auth.'
    Type: String
    Default: ""

  LambdaAuthorizerArn:
    Description: '[Optional] The Arn of the existing Lambda Authoriser to use. Leave blank to use default one.'
    Type: String
    Default: ""
    ConstraintDescription: A valid AWS Lambda Function Arn
    AllowedPattern: ^$|arn:aws[a-z-]*:lambda:[a-z0-9-]+:\d{12}:function:[a-zA-Z0-9-_]+$

Rules:
  AuthParameterValidation:
    Assertions:
      - Assert: !Or
          - !Equals [!Ref JwtIssuerUrl, ""]
          - !Equals [!Ref LambdaAuthorizerArn, ""]
        AssertDescription: Only one of JwtIssuerUrl or LambdaAuthorizerArn can be provided, not both.

Mappings:
  Solution:
    Constants:
      ApiVersion: "8.0"
      ServiceVersion: 5.0.3

Conditions:
  CreateVpc: !Equals [!Ref VpcId, ""]

  CreateWaf: !Equals [!Ref DeployWaf, "Yes"]

  CreateCognito: !Equals [!Ref JwtIssuerUrl, ""]

  CreateLambdaAuthorizer: !Equals [!Ref LambdaAuthorizerArn, ""]

  CognitoAndLambdaAuthorizer: !And [!Condition CreateCognito, !Condition CreateLambdaAuthorizer]

Transform: AWS::Serverless-2016-10-31

Globals:
  Function:
    Tracing: Active
    Timeout: 30
    MemorySize: 1024
    Handler: app.lambda_handler
    Runtime: python3.13
    Architectures:
      - arm64
    VpcConfig:
      SubnetIds: !If [CreateVpc, !Split [',', !GetAtt VpcStack.Outputs.PrivateSubnetIds], !Ref PrivateSubnetIds]
      SecurityGroupIds:
        - !Ref LambdaSecurityGroup

Resources:
  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name: !Ref AWS::StackName
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0

  ApplicationInsightsMonitoring:
    Type: AWS::ApplicationInsights::Application
    Properties:
      ResourceGroupName: !Ref ApplicationResourceGroup
      AutoConfigurationEnabled: True

  LambdaAuthorizerFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Vpc not wanted
          - id: W92
            reason: ReservedConcurrentExecutions not required
    Properties:
      VpcConfig: !Ref AWS::NoValue
      Timeout: 10
      MemorySize: 256
      CodeUri: functions/lambda_authorizer/
      Layers:
        - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python313-arm64:23
      Environment:
        Variables:
          POWERTOOLS_LOG_LEVEL: INFO
          POWERTOOLS_SERVICE_NAME: tams-lambda-authorizer
          POWERTOOLS_METRICS_NAMESPACE: TAMS
          ALLOWED_ISSUERS: !If [CreateCognito, !Sub 'https://cognito-idp.${AWS::Region}.${AWS::URLSuffix}/${CognitoStack.Outputs.UserPoolId}', !Ref JwtIssuerUrl]
    Condition: CreateLambdaAuthorizer

  LambdaAuthorizerFunctionRoleCognitoPolicy:
    Type: AWS::IAM::RolePolicy
    Properties:
      RoleName: !Ref LambdaAuthorizerFunctionRole
      PolicyName: cognito
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - cognito-idp:DescribeUserPool
              - cognito-idp:AdminGetUser
              - cognito-idp:DescribeUserPoolClient
            Resource: !Sub arn:${AWS::Partition}:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${CognitoStack.Outputs.UserPoolId}
    Condition: CognitoAndLambdaAuthorizer

  Api:
    Type: AWS::Serverless::Api
    Properties:
      Name: Time-addressable Media Store
      Description: |
        The Time-addressable Media Store (TAMS) is used for storing segmented media flows.
        The TAMS consists of a media store for the media flow segment objects and a service providing
        a database index of the flow segments. This document is a specification of the service API.

        See the [bbc/tams](https://github.com/bbc/tams) repository for more background on TAMS.

        **Note**: the examples provided in this specification are for a system which uses a media
        store that provides HTTP URLs for uploading and downloading media objects in buckets. This
        could for example be implemented using an AWS S3 compatible store using presigned URLs or by
        a simple file system storage with an HTTP frontend. Clients should parse the /service endpoint
        and handle the media store type in use appropriately.
      OpenApiVersion: 3.0.1
      EndpointConfiguration:
        Type: REGIONAL
      TracingEnabled: True
      MethodSettings:
        - ResourcePath: /*
          HttpMethod: '*'
          DataTraceEnabled: True
          LoggingLevel: INFO
          MetricsEnabled: True
      StageName: Prod
      AlwaysDeploy: True
      Variables:
        api_version: !FindInMap [Solution, Constants, ApiVersion]
        service_version: !Sub
          - aws.${ServiceVersion}
          - ServiceVersion: !FindInMap [Solution, Constants, ServiceVersion]
      Cors:
        AllowMethods: '''*'''
        AllowHeaders: '''Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'''
        AllowOrigin: '''*'''
      Auth:
        AddDefaultAuthorizerToCorsPreflight: False
        DefaultAuthorizer: Authorizer
        Authorizers:
          Authorizer:
            FunctionArn: !If [CreateLambdaAuthorizer, !GetAtt LambdaAuthorizerFunction.Arn, !Ref LambdaAuthorizerArn]
            FunctionPayloadType: REQUEST
            Identity:
              Headers:
                - Authorization
              Context:
                - httpMethod
                - resourcePath
              ReauthorizeEvery: 300

  ServiceTable:
    DeletionPolicy: RetainExceptOnCreate
    UpdateReplacePolicy: Retain
    Type: AWS::DynamoDB::Table
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W74
            reason: Encryption not required
          - id: W78
            reason: Backup not required
    Properties:
      SSESpecification:
        SSEEnabled: True
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: record_type
          AttributeType: S
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: record_type
          KeyType: HASH
        - AttributeName: id
          KeyType: RANGE

  FlowSegmentsTable:
    DeletionPolicy: RetainExceptOnCreate
    UpdateReplacePolicy: Retain
    Type: AWS::DynamoDB::Table
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W74
            reason: Encryption not required
          - id: W78
            reason: Backup not required
    Properties:
      SSESpecification:
        SSEEnabled: True
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: flow_id
          AttributeType: S
        - AttributeName: timerange_end
          AttributeType: "N"
        - AttributeName: object_id
          AttributeType: S
      KeySchema:
        - AttributeName: flow_id
          KeyType: HASH
        - AttributeName: timerange_end
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: object-id-index
          KeySchema:
            - AttributeName: object_id
              KeyType: HASH
            - AttributeName: flow_id
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  FlowStorageTable:
    DeletionPolicy: RetainExceptOnCreate
    UpdateReplacePolicy: Retain
    Type: AWS::DynamoDB::Table
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W74
            reason: Encryption not required
          - id: W78
            reason: Backup not required
    Properties:
      SSESpecification:
        SSEEnabled: True
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expire_at
        Enabled: true

  MediaStorageBucket:
    DeletionPolicy: RetainExceptOnCreate
    UpdateReplacePolicy: Retain
    Type: AWS::S3::Bucket
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W35
            reason: Access logging not required
          - id: W51
            reason: Bucket policy not required
    Properties:
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - '*'
            AllowedMethods:
              - GET
            AllowedOrigins:
              - '*'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - BucketKeyEnabled: False
            ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: True
        BlockPublicPolicy: True
        IgnorePublicAcls: True
        RestrictPublicBuckets: True

  CrStorageBackendFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Vpc defined in Globals section
          - id: W92
            reason: ReservedConcurrentExecutions not required
    Properties:
      CodeUri: functions/cr_storage_backend/
      Environment:
        Variables:
          SERVICE_TABLE: !Ref ServiceTable
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:PutItem
                - dynamodb:DeleteItem
              Resource:
                - !GetAtt ServiceTable.Arn

  StorageBackend:
    Type: Custom::StorageBackend
    Properties:
      ServiceToken: !GetAtt CrStorageBackendFunction.Arn
      default_storage: True
      bucket_name: !Ref MediaStorageBucket
      region: !Ref AWS::Region

  DeleteRequestQueue:
    Type: AWS::SQS::Queue
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W48
            reason: Encryption not required
    Properties:
      VisibilityTimeout: 900
      MessageRetentionPeriod: 86400

  CleanupS3Queue:
    Type: AWS::SQS::Queue
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W48
            reason: Encryption not required
    Properties:
      VisibilityTimeout: 900
      MessageRetentionPeriod: 86400

  WebhooksDeliveryQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: alias/aws/sqs
      VisibilityTimeout: 900
      MessageRetentionPeriod: 86400
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt WebhooksDeliveryQueueDLQ.Arn
        maxReceiveCount: 1

  WebhooksDeliveryQueueDLQ:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: alias/aws/sqs
      VisibilityTimeout: 900
      MessageRetentionPeriod: 86400

  WebhooksErrorQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: alias/aws/sqs
      VisibilityTimeout: 30
      MessageRetentionPeriod: 86400

  WebhooksDeliveryQueueDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: TAMS Webhooks DLQ Queue has visible messages
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Average
      Dimensions:
        - Name: QueueName
          Value: !GetAtt WebhooksDeliveryQueueDLQ.QueueName
      Period: 300
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: missing

  ObjectDuplicationQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: alias/aws/sqs
      VisibilityTimeout: 900
      MessageRetentionPeriod: 86400
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ObjectDuplicationQueueDLQ.Arn
        maxReceiveCount: 1

  ObjectDuplicationQueueDLQ:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: alias/aws/sqs
      VisibilityTimeout: 900
      MessageRetentionPeriod: 86400

  EventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Ref AWS::StackName

  UtilsLayer:
    Type: AWS::Serverless::LayerVersion
    Metadata:
      BuildMethod: python3.13
      BuildArchitecture: arm64
    Properties:
      RetentionPolicy: Delete
      ContentUri: layers/utils/
      CompatibleRuntimes:
        - python3.13
      CompatibleArchitectures:
        - arm64

  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W5
            reason: Outbound https to all epxected
    Properties:
      GroupDescription: Security group for Vpc Lambdas
      VpcId: !If [CreateVpc, !GetAtt VpcStack.Outputs.VpcId, !Ref VpcId]
      SecurityGroupEgress:
        - Description: Explicit egress group locking down outbound access to only HTTPS
          CidrIp: 0.0.0.0/0
          IpProtocol: tcp
          ToPort: 443
          FromPort: 443
        - Description: Explicit egress group locking down outbound access to only Neptune
          CidrIp: 0.0.0.0/0
          IpProtocol: tcp
          ToPort: 8182
          FromPort: 8182

  ServiceFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Vpc defined in Globals section
          - id: W92
            reason: ReservedConcurrentExecutions not required
    Properties:
      CodeUri: functions/api_service/
      Layers:
        - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python313-arm64:23
        - !Ref UtilsLayer
      Environment:
        Variables:
          POWERTOOLS_LOG_LEVEL: INFO
          POWERTOOLS_SERVICE_NAME: tams-service
          POWERTOOLS_METRICS_NAMESPACE: TAMS
          NEPTUNE_ENDPOINT: !GetAtt NeptuneStack.Outputs.Endpoint
          SERVICE_TABLE: !Ref ServiceTable
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:GetItem
                - dynamodb:PutItem
              Resource:
                - !GetAtt ServiceTable.Arn
            - Effect: Allow
              Action:
                - neptune-db:ReadDataViaQuery
                - neptune-db:WriteDataViaQuery
                - neptune-db:DeleteDataViaQuery
              Resource: !Sub arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${NeptuneStack.Outputs.ClusterResourceId}/*
              Condition:
                StringEquals:
                  neptune-db:QueryLanguage: OpenCypher
      Events:
        headRoot:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /
            Method: Head
        getRoot:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /
            Method: Get
        headService:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /service
            Method: Head
        getService:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /service
            Method: Get
        postService:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /service
            Method: Post
        headStorageBackends:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /service/storage-backends
            Method: Head
        getStorageBackends:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /service/storage-backends
            Method: Get
        headServiceWebhooks:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /service/webhooks
            Method: Head
        getServiceWebhooks:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /service/webhooks
            Method: Get
        postServiceWebhooks:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /service/webhooks
            Method: Post
        headServiceWebhookWebhookId:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /service/webhooks/{webhookId}
            Method: Head
        getServiceWebhookWebhookId:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /service/webhooks/{webhookId}
            Method: Get
        putServiceWebhookWebhookId:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /service/webhooks/{webhookId}
            Method: Put
        deleteServiceWebhookWebhookId:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /service/webhooks/{webhookId}
            Method: Delete
        anyRoot:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /
            Method: Any
        proxyPath:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /{proxy+}
            Method: Any

  SourcesFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Vpc defined in Globals section
          - id: W92
            reason: ReservedConcurrentExecutions not required
    Properties:
      CodeUri: functions/api_sources/
      Layers:
        - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python313-arm64:23
        - !Ref UtilsLayer
      Environment:
        Variables:
          POWERTOOLS_LOG_LEVEL: INFO
          POWERTOOLS_SERVICE_NAME: tams-sources
          POWERTOOLS_METRICS_NAMESPACE: TAMS
          NEPTUNE_ENDPOINT: !GetAtt NeptuneStack.Outputs.Endpoint
          EVENT_BUS: !Ref EventBus
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: !GetAtt EventBus.Arn
            - Effect: Allow
              Action:
                - neptune-db:ReadDataViaQuery
                - neptune-db:WriteDataViaQuery
                - neptune-db:DeleteDataViaQuery
              Resource: !Sub arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${NeptuneStack.Outputs.ClusterResourceId}/*
              Condition:
                StringEquals:
                  neptune-db:QueryLanguage: OpenCypher
      Events:
        headSources:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources
            Method: Head
        getSources:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources
            Method: Get
        headSourcesSourceid:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}
            Method: Head
        getSourcesSourceid:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}
            Method: Get
        headSourcesSourceidTags:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}/tags
            Method: Head
        getSourcesSourceidTags:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}/tags
            Method: Get
        headSourcesSourceidTagsName:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}/tags/{name}
            Method: Head
        getSourcesSourceidTagsName:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}/tags/{name}
            Method: Get
        putSourcesSourceidTagsName:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}/tags/{name}
            Method: Put
        deleteSourcesSourceidTagsName:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}/tags/{name}
            Method: Delete
        headSourcesSourceidDescription:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}/description
            Method: Head
        getSourcesSourceidDescription:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}/description
            Method: Get
        putSourcesSourceidDescription:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}/description
            Method: Put
        deleteSourcesSourceidDescription:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}/description
            Method: Delete
        headSourcesSourceidLabel:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}/label
            Method: Head
        getSourcesSourceidLabel:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}/label
            Method: Get
        putSourcesSourceidLabel:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}/label
            Method: Put
        deleteSourcesSourceidLabel:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /sources/{sourceId}/label
            Method: Delete

  FlowsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W76
          - id: W89
            reason: Vpc defined in Globals section
          - id: W92
            reason: ReservedConcurrentExecutions not required
    Properties:
      CodeUri: functions/api_flows/
      Layers:
        - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python313-arm64:23
        - !Ref UtilsLayer
      Environment:
        Variables:
          POWERTOOLS_LOG_LEVEL: INFO
          POWERTOOLS_SERVICE_NAME: tams-flows
          POWERTOOLS_METRICS_NAMESPACE: TAMS
          NEPTUNE_ENDPOINT: !GetAtt NeptuneStack.Outputs.Endpoint
          EVENT_BUS: !Ref EventBus
          SERVICE_TABLE: !Ref ServiceTable
          SEGMENTS_TABLE: !Ref FlowSegmentsTable
          STORAGE_TABLE: !Ref FlowStorageTable
          DELETE_QUEUE_URL: !Ref DeleteRequestQueue
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: !GetAtt EventBus.Arn
            - Effect: Allow
              Action:
                - dynamodb:Query
              Resource:
                - !GetAtt ServiceTable.Arn
                - !GetAtt FlowSegmentsTable.Arn
            - Effect: Allow
              Action:
                - dynamodb:GetItem
              Resource:
                - !GetAtt ServiceTable.Arn
                - !GetAtt FlowStorageTable.Arn
            - Effect: Allow
              Action:
                - dynamodb:PutItem
              Resource:
                - !GetAtt FlowStorageTable.Arn
            - Effect: Allow
              Action:
                - s3:PutObject
              Resource:
                - !Sub ${MediaStorageBucket.Arn}/*
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource:
                - !GetAtt DeleteRequestQueue.Arn
            - Effect: Allow
              Action:
                - neptune-db:ReadDataViaQuery
                - neptune-db:WriteDataViaQuery
                - neptune-db:DeleteDataViaQuery
              Resource: !Sub arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${NeptuneStack.Outputs.ClusterResourceId}/*
              Condition:
                StringEquals:
                  neptune-db:QueryLanguage: OpenCypher
      Events:
        headFlows:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows
            Method: Head
        getFlows:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows
            Method: Get
        headFlowsFlowid:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}
            Method: Head
        getFlowsFlowid:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}
            Method: Get
        putFlowsFlowid:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}
            Method: Put
        deleteFlowsFlowid:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}
            Method: Delete
        headFlowsFlowidTags:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/tags
            Method: Head
        getFlowsFlowidTags:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/tags
            Method: Get
        headFlowsFlowidTagsName:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/tags/{name}
            Method: Head
        getFlowsFlowidTagsName:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/tags/{name}
            Method: Get
        putFlowsFlowidTagsName:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/tags/{name}
            Method: Put
        deleteFlowsFlowidTagsName:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/tags/{name}
            Method: Delete
        headFlowsFlowidDescription:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/description
            Method: Head
        getFlowsFlowidDescription:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/description
            Method: Get
        putFlowsFlowidDescription:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/description
            Method: Put
        deleteFlowsFlowidDescription:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/description
            Method: Delete
        headFlowsFlowidLabel:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/label
            Method: Head
        getFlowsFlowidLabel:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/label
            Method: Get
        putFlowsFlowidLabel:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/label
            Method: Put
        deleteFlowsFlowidLabel:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/label
            Method: Delete
        headFlowsFlowidReadonly:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/read_only
            Method: Head
        getFlowsFlowidReadonly:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/read_only
            Method: Get
        putFlowsFlowidReadonly:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/read_only
            Method: Put
        headFlowsFlowidFlowCollection:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/flow_collection
            Method: Head
        getFlowsFlowidFlowCollection:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/flow_collection
            Method: Get
        putFlowsFlowidFlowCollection:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/flow_collection
            Method: Put
        deleteFlowsFlowidFlowCollection:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/flow_collection
            Method: Delete
        headFlowsFlowidMaxBitRate:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/max_bit_rate
            Method: Head
        getFlowsFlowidMaxBitRate:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/max_bit_rate
            Method: Get
        putFlowsFlowidMaxBitRate:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/max_bit_rate
            Method: Put
        deleteFlowsFlowidMaxBitRate:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/max_bit_rate
            Method: Delete
        headFlowsFlowidAvgBitRate:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/avg_bit_rate
            Method: Head
        getFlowsFlowidAvgBitRate:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/avg_bit_rate
            Method: Get
        putFlowsFlowidAvgBitRate:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/avg_bit_rate
            Method: Put
        deleteFlowsFlowidAvgBitRate:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/avg_bit_rate
            Method: Delete
        postFlowsFlowidStorage:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/storage
            Method: Post

  FlowSegmentsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W76
          - id: W89
            reason: Vpc defined in Globals section
          - id: W92
            reason: ReservedConcurrentExecutions not required
    Properties:
      CodeUri: functions/api_flow_segments/
      Layers:
        - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python313-arm64:23
        - !Ref UtilsLayer
      Environment:
        Variables:
          POWERTOOLS_LOG_LEVEL: INFO
          POWERTOOLS_SERVICE_NAME: tams-segments
          POWERTOOLS_METRICS_NAMESPACE: TAMS
          NEPTUNE_ENDPOINT: !GetAtt NeptuneStack.Outputs.Endpoint
          EVENT_BUS: !Ref EventBus
          SERVICE_TABLE: !Ref ServiceTable
          SEGMENTS_TABLE: !Ref FlowSegmentsTable
          STORAGE_TABLE: !Ref FlowStorageTable
          S3_QUEUE_URL: !Ref CleanupS3Queue
          DELETE_QUEUE_URL: !Ref DeleteRequestQueue
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: !GetAtt EventBus.Arn
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:PutItem
                - dynamodb:DeleteItem
              Resource:
                - !GetAtt FlowSegmentsTable.Arn
                - !Sub ${FlowSegmentsTable.Arn}/index/object-id-index
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
              Resource:
                - !GetAtt FlowStorageTable.Arn
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource:
                - !GetAtt DeleteRequestQueue.Arn
                - !GetAtt CleanupS3Queue.Arn
            - Effect: Allow
              Action:
                - s3:GetObject
              Resource:
                - !Sub ${MediaStorageBucket.Arn}/*
            - Effect: Allow
              Action:
                - neptune-db:ReadDataViaQuery
                - neptune-db:WriteDataViaQuery
                - neptune-db:DeleteDataViaQuery
              Resource: !Sub arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${NeptuneStack.Outputs.ClusterResourceId}/*
              Condition:
                StringEquals:
                  neptune-db:QueryLanguage: OpenCypher
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:GetItem
              Resource:
                - !GetAtt ServiceTable.Arn
      Events:
        headFlowsFlowidSegments:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/segments
            Method: Head
        getFlowsFlowidSegments:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/segments
            Method: Get
        postFlowsFlowidSegments:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/segments
            Method: Post
        deleteFlowsFlowidSegments:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flows/{flowId}/segments
            Method: Delete

  ObjectsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W76
          - id: W89
            reason: Vpc defined in Globals section
          - id: W92
            reason: ReservedConcurrentExecutions not required
    Properties:
      CodeUri: functions/api_objects/
      Layers:
        - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python313-arm64:23
        - !Ref UtilsLayer
      Environment:
        Variables:
          POWERTOOLS_LOG_LEVEL: INFO
          POWERTOOLS_SERVICE_NAME: tams-segments
          POWERTOOLS_METRICS_NAMESPACE: TAMS
          NEPTUNE_ENDPOINT: !GetAtt NeptuneStack.Outputs.Endpoint
          SERVICE_TABLE: !Ref ServiceTable
          SEGMENTS_TABLE: !Ref FlowSegmentsTable
          STORAGE_TABLE: !Ref FlowStorageTable
          DUPLICATION_QUEUE_URL: !Ref ObjectDuplicationQueue
          S3_QUEUE_URL: !Ref CleanupS3Queue
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:Query
              Resource:
                - !Sub ${FlowSegmentsTable.Arn}/index/object-id-index
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:UpdateItem
              Resource:
                - !GetAtt FlowSegmentsTable.Arn
            - Effect: Allow
              Action:
                - dynamodb:GetItem
              Resource:
                - !GetAtt FlowStorageTable.Arn
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:GetItem
              Resource:
                - !GetAtt ServiceTable.Arn
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource:
                - !GetAtt ObjectDuplicationQueue.Arn
                - !GetAtt CleanupS3Queue.Arn
            - Effect: Allow
              Action:
                - neptune-db:ReadDataViaQuery
              Resource: !Sub arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${NeptuneStack.Outputs.ClusterResourceId}/*
              Condition:
                StringEquals:
                  neptune-db:QueryLanguage: OpenCypher
      Events:
        headMediaObjectInformation:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /objects/{objectId}
            Method: Head
        getMediaObjectInformation:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /objects/{objectId}
            Method: Get
        postMediaObjectInstance:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /objects/{objectId}/instances
            Method: Post
        deleteMediaObjectInstance:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /objects/{objectId}/instances
            Method: Delete

  FlowDeleteRequestsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Vpc defined in Globals section
          - id: W92
            reason: ReservedConcurrentExecutions not required
    Properties:
      CodeUri: functions/api_flow_delete_requests/
      Layers:
        - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python313-arm64:23
        - !Ref UtilsLayer
      Environment:
        Variables:
          POWERTOOLS_LOG_LEVEL: INFO
          POWERTOOLS_SERVICE_NAME: tams-deletion
          POWERTOOLS_METRICS_NAMESPACE: TAMS
          NEPTUNE_ENDPOINT: !GetAtt NeptuneStack.Outputs.Endpoint
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - neptune-db:ReadDataViaQuery
                - neptune-db:WriteDataViaQuery
                - neptune-db:DeleteDataViaQuery
              Resource: !Sub arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${NeptuneStack.Outputs.ClusterResourceId}/*
              Condition:
                StringEquals:
                  neptune-db:QueryLanguage: OpenCypher
      Events:
        headFlowDeleteRequests:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flow-delete-requests
            Method: Head
        getFlowDeleteRequests:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flow-delete-requests
            Method: Get
        headFlowDeleteRequestsRequestId:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flow-delete-requests/{request-id}
            Method: Head
        getFlowDeleteRequestsRequestId:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /flow-delete-requests/{request-id}
            Method: Get

  WebhooksFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Vpc defined in Globals section
          - id: W92
            reason: ReservedConcurrentExecutions not required
    Properties:
      CodeUri: functions/webhooks/
      Layers:
        - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python313-arm64:23
        - !Ref UtilsLayer
      Environment:
        Variables:
          POWERTOOLS_LOG_LEVEL: INFO
          POWERTOOLS_SERVICE_NAME: tams-webhooks
          POWERTOOLS_METRICS_NAMESPACE: TAMS
          NEPTUNE_ENDPOINT: !GetAtt NeptuneStack.Outputs.Endpoint
          SERVICE_TABLE: !Ref ServiceTable
          WEBHOOKS_QUEUE_URL: !Ref WebhooksDeliveryQueue
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:GetItem
              Resource:
                - !GetAtt ServiceTable.Arn
            - Effect: Allow
              Action:
                - neptune-db:ReadDataViaQuery
                - neptune-db:WriteDataViaQuery
                - neptune-db:DeleteDataViaQuery
              Resource: !Sub arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${NeptuneStack.Outputs.ClusterResourceId}/*
              Condition:
                StringEquals:
                  neptune-db:QueryLanguage: OpenCypher
            - Effect: Allow
              Action:
                - s3:GetObject
              Resource:
                - !Sub ${MediaStorageBucket.Arn}/*
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource:
                - !GetAtt WebhooksDeliveryQueue.Arn
      Events:
        EventBridge:
          Type: EventBridgeRule
          Properties:
            RuleName: !Sub ${AWS::StackName}-events
            EventBusName: !Ref EventBus
            Pattern:
              source:
                - tams.api

  WebhooksDeliveryFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Vpc defined in Globals section
          - id: W92
            reason: ReservedConcurrentExecutions not required
    Properties:
      VpcConfig: !Ref AWS::NoValue
      CodeUri: functions/webhooks_delivery/
      Layers:
        - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python313-arm64:23
        - !Ref UtilsLayer
      Timeout: 900
      Environment:
        Variables:
          POWERTOOLS_LOG_LEVEL: INFO
          POWERTOOLS_SERVICE_NAME: tams-webhooks-delivery
          POWERTOOLS_METRICS_NAMESPACE: TAMS
          ERROR_QUEUE_URL: !Ref WebhooksErrorQueue
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource:
                - !GetAtt WebhooksErrorQueue.Arn
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt WebhooksDeliveryQueue.Arn
            BatchSize: 10
            Enabled: True
            FunctionResponseTypes:
              - ReportBatchItemFailures

  WebhooksErrorFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Vpc defined in Globals section
          - id: W92
            reason: ReservedConcurrentExecutions not required
    Properties:
      CodeUri: functions/webhooks_error/
      Layers:
        - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python313-arm64:23
        - !Ref UtilsLayer
      Environment:
        Variables:
          POWERTOOLS_LOG_LEVEL: INFO
          POWERTOOLS_SERVICE_NAME: tams-webhooks
          POWERTOOLS_METRICS_NAMESPACE: TAMS
          NEPTUNE_ENDPOINT: !GetAtt NeptuneStack.Outputs.Endpoint
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - neptune-db:ReadDataViaQuery
                - neptune-db:WriteDataViaQuery
                - neptune-db:DeleteDataViaQuery
              Resource: !Sub arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${NeptuneStack.Outputs.ClusterResourceId}/*
              Condition:
                StringEquals:
                  neptune-db:QueryLanguage: OpenCypher
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt WebhooksErrorQueue.Arn
            BatchSize: 10
            Enabled: True
            FunctionResponseTypes:
              - ReportBatchItemFailures

  ObjectDuplicationFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Vpc defined in Globals section
          - id: W92
            reason: ReservedConcurrentExecutions not required
    Properties:
      CodeUri: functions/object_duplication/
      Layers:
        - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python313-arm64:18
        - !Ref UtilsLayer
      Timeout: 900
      Environment:
        Variables:
          POWERTOOLS_LOG_LEVEL: INFO
          POWERTOOLS_SERVICE_NAME: tams-object-duplication
          POWERTOOLS_METRICS_NAMESPACE: TAMS
          SERVICE_TABLE: !Ref ServiceTable
          SEGMENTS_TABLE: !Ref FlowSegmentsTable
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:Query
              Resource:
                - !Sub ${FlowSegmentsTable.Arn}/index/object-id-index
            - Effect: Allow
              Action:
                - dynamodb:UpdateItem
              Resource:
                - !GetAtt FlowSegmentsTable.Arn
            - Effect: Allow
              Action:
                - dynamodb:GetItem
              Resource:
                - !GetAtt ServiceTable.Arn
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
              Resource:
                - !Sub ${MediaStorageBucket.Arn}/*
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt ObjectDuplicationQueue.Arn
            BatchSize: 10
            Enabled: True
            FunctionResponseTypes:
              - ReportBatchItemFailures

  SqsDeleteRequestsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Vpc defined in Globals section
          - id: W92
            reason: ReservedConcurrentExecutions not required
    Properties:
      CodeUri: functions/sqs_delete_requests/
      Layers:
        - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python313-arm64:23
        - !Ref UtilsLayer
      Timeout: 900
      Environment:
        Variables:
          POWERTOOLS_LOG_LEVEL: INFO
          POWERTOOLS_SERVICE_NAME: tams-sqs-delete-requests
          POWERTOOLS_METRICS_NAMESPACE: TAMS
          NEPTUNE_ENDPOINT: !GetAtt NeptuneStack.Outputs.Endpoint
          EVENT_BUS: !Ref EventBus
          SEGMENTS_TABLE: !Ref FlowSegmentsTable
          STORAGE_TABLE: !Ref FlowStorageTable
          S3_QUEUE_URL: !Ref CleanupS3Queue
          DELETE_QUEUE_URL: !Ref DeleteRequestQueue
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: !GetAtt EventBus.Arn
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:DeleteItem
              Resource:
                - !GetAtt FlowSegmentsTable.Arn
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource:
                - !GetAtt CleanupS3Queue.Arn
                - !GetAtt DeleteRequestQueue.Arn
            - Effect: Allow
              Action:
                - neptune-db:ReadDataViaQuery
                - neptune-db:WriteDataViaQuery
                - neptune-db:DeleteDataViaQuery
              Resource: !Sub arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${NeptuneStack.Outputs.ClusterResourceId}/*
              Condition:
                StringEquals:
                  neptune-db:QueryLanguage: OpenCypher
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt DeleteRequestQueue.Arn
            BatchSize: 10
            Enabled: True
            FunctionResponseTypes:
              - ReportBatchItemFailures

  SqsObjectCleanupFunction:
    Type: AWS::Serverless::Function
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: Vpc defined in Globals section
          - id: W92
            reason: ReservedConcurrentExecutions not required
    Properties:
      CodeUri: functions/sqs_object_cleanup/
      Layers:
        - !Sub arn:${AWS::Partition}:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python313-arm64:23
        - !Ref UtilsLayer
      Timeout: 900
      Environment:
        Variables:
          POWERTOOLS_LOG_LEVEL: INFO
          POWERTOOLS_SERVICE_NAME: tams-cleanup
          POWERTOOLS_METRICS_NAMESPACE: TAMS
          NEPTUNE_ENDPOINT: !GetAtt NeptuneStack.Outputs.Endpoint
          SERVICE_TABLE: !Ref ServiceTable
          SEGMENTS_TABLE: !Ref FlowSegmentsTable
          STORAGE_TABLE: !Ref FlowStorageTable
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:Query
              Resource:
                - !Sub ${FlowSegmentsTable.Arn}/index/object-id-index
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:UpdateItem
                - dynamodb:DeleteItem
              Resource:
                - !GetAtt FlowStorageTable.Arn
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:GetItem
              Resource:
                - !GetAtt ServiceTable.Arn
            - Effect: Allow
              Action:
                - s3:DeleteObject
              Resource:
                - !Sub ${MediaStorageBucket.Arn}/*
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt CleanupS3Queue.Arn
            BatchSize: 10
            Enabled: True
            FunctionResponseTypes:
              - ReportBatchItemFailures

  CognitoStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: templates/cognito.yaml
    Condition: CreateCognito

  VpcStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: templates/vpc.yaml
    Condition: CreateVpc

  NeptuneStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: templates/neptune.yaml
      Parameters:
        VpcId: !If [CreateVpc, !GetAtt VpcStack.Outputs.VpcId, !Ref VpcId]
        VpcAZs: !If [CreateVpc, !GetAtt VpcStack.Outputs.VpcAZs, !Join [',', !Ref VpcAZs]]
        PrivateSubnetIds: !If [CreateVpc, !GetAtt VpcStack.Outputs.PrivateSubnetIds, !Join [',', !Ref PrivateSubnetIds]]
        LambdaSecurityGroupId: !Ref LambdaSecurityGroup
        ServerlessScalingConfiguration: !Ref NeptuneServerlessConfiguration
        DBInstanceClass: !Ref NeptuneDBInstanceClass

  WafStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: templates/waf.yaml
      Parameters:
        ParentStackName: !Ref AWS::StackName
        ApiGwArn: !Sub arn:${AWS::Partition}:apigateway:${AWS::Region}::/restapis/${Api}/stages/${Api.Stage}
    Condition: CreateWaf

Outputs:
  ApiEndpoint:
    Value: !Sub https://${Api}.execute-api.${AWS::Region}.amazonaws.com/${Api.Stage}
    Export:
      Name: !Sub ${AWS::StackName}-ApiEndpoint

  UserPoolId:
    Value: !If [CreateCognito, !GetAtt CognitoStack.Outputs.UserPoolId, ""]
    Export:
      Name: !Sub ${AWS::StackName}-UserPoolId

  TokenUrl:
    Value: !If [CreateCognito, !GetAtt CognitoStack.Outputs.TokenUrl, ""]
    Export:
      Name: !Sub ${AWS::StackName}-TokenUrl

  UserPoolClientId:
    Value: !If [CreateCognito, !GetAtt CognitoStack.Outputs.UserPoolClientId, ""]
    Export:
      Name: !Sub ${AWS::StackName}-UserPoolClientId

  UserPoolClientWebId:
    Value: !If [CreateCognito, !GetAtt CognitoStack.Outputs.UserPoolClientWebId, ""]

  IdentityPoolId:
    Value: !If [CreateCognito, !GetAtt CognitoStack.Outputs.IdentityPoolId, ""]

  MediaStorageBucket:
    Value: !Ref MediaStorageBucket
    Export:
      Name: !Sub ${AWS::StackName}-MediaStorageBucket

  FlowSegmentsTable:
    Value: !Ref FlowSegmentsTable

  FlowStorageTable:
    Value: !Ref FlowStorageTable

  CleanupS3QueueUrl:
    Value: !Ref CleanupS3Queue

  AuthRoleName:
    Value: !If [CreateCognito, !GetAtt CognitoStack.Outputs.AuthRoleName, ""]
    Export:
      Name: !Sub ${AWS::StackName}-AuthRoleName

  NeptuneEndpoint:
    Value: !GetAtt NeptuneStack.Outputs.Endpoint

  NeptuneClusterResourceId:
    Value: !GetAtt NeptuneStack.Outputs.ClusterResourceId

  LambdaSubnetIds:
    Value: !If [CreateVpc, !GetAtt VpcStack.Outputs.PrivateSubnetIds, !Join [',', !Ref PrivateSubnetIds]]

  LambdaSecurityGroup:
    Value: !Ref LambdaSecurityGroup

  UtilsLayerArn:
    Value: !Ref UtilsLayer

  AdditionalStorageCrStorageBackendFunctionArn:
    Value: !GetAtt CrStorageBackendFunction.Arn
    Export:
      Name: !Sub ${AWS::StackName}-AdditionalStorage-CrStorageBackendFunctionArn

  AdditionalStorageFlowsFunctionRole:
    Value: !Ref FlowsFunctionRole
    Export:
      Name: !Sub ${AWS::StackName}-AdditionalStorage-FlowsFunctionRole

  AdditionalStorageFlowSegmentsFunctionRole:
    Value: !Ref FlowSegmentsFunctionRole
    Export:
      Name: !Sub ${AWS::StackName}-AdditionalStorage-FlowSegmentsFunctionRole

  AdditionalStorageObjectsFunctionRole:
    Value: !Ref ObjectsFunctionRole
    Export:
      Name: !Sub ${AWS::StackName}-AdditionalStorage-ObjectsFunctionRole

  AdditionalStorageWebhooksFunctionRole:
    Value: !Ref WebhooksFunctionRole
    Export:
      Name: !Sub ${AWS::StackName}-AdditionalStorage-WebhooksFunctionRole

  AdditionalStorageSqsObjectCleanupFunctionRole:
    Value: !Ref SqsObjectCleanupFunctionRole
    Export:
      Name: !Sub ${AWS::StackName}-AdditionalStorage-SqsObjectCleanupFunctionRole

  AdditionalStorageObjectDuplicationFunctionRole:
    Value: !Ref ObjectDuplicationFunctionRole
    Export:
      Name: !Sub ${AWS::StackName}-AdditionalStorage-ObjectDuplicationFunctionRole
